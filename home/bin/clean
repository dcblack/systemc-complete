#!/usr/bin/bash

SYNTAX="SYNTAX: clean [-exe|-logs|-all] [DIRLIST]"

function Realpath () {
  test -z "$*" && echo "" || \
  perl '-MCwd(abs_path)' -le "print abs_path(qq($*))"
}

unset DIRS
declare -a DIRS
V='-v'
let i=0
OPTS=
while [[ $# -gt 0 ]]; do
  if [[ "$1" =~ ^-{1,2}h(elp)?$ ]]; then
    echo $SYNTAX
    exit 0
  elif [[ "$1" =~ ^-{1,2}q(uiet)?$ ]]; then
    V=''
  elif [[ "$1" =~ ^-{1,2}v(erbose)?$ ]]; then
    V='-v'
  elif [[ "$1" =~ ^-{1,2}a(ll)$ ]]; then
    OPTS=A
  elif [[ "$1" =~ ^-{1,2}exe$ || "$1" =~ ^-x$ ]]; then
    OPTS+=X
  elif [[ "$1" =~ ^-{1,2}logs$ ]]; then
    OPTS+=L
  elif [[ "$1" =~ ^- ]]; then
    echo "ERROR: Unknown option '$1'." 1>&2
    exit 1
  elif [[ -d "$1" ]]; then
    let ++i
    DIRS[$i]="$1"
  else
    echo "ERROR: Bad directory '$1'." 1>&2
    exit 1
  fi
  shift
done
if [[ ${#DIR[@]} == 0 ]]; then
  DIR[1]=.
fi

for DIR in ${DIRS[@]}; do
  find "$DIR" -name '*.[doP]' -exec rm $V {} \;
  if   [[ $COMMAND =~ L ]]; then
    find "$DIR" -type f -name '*.log' -exec rm $V {} \;
  elif [[ $OPTS =~ X ]]; then
    find "$DIR" -type f -name '*.x' -exec rm $V {} \;
  elif [[ $OPTS =~ A ]]; then
    find "$DIR" -type f -name '*.log' -exec rm $V {} \;
    find "$DIR" -type d -name build -exec rm $V -fr {} \;
  fi
done
